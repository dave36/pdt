import os
import sys
from src.util.validator import *

sys.path.append('src/04_Reporting/')
from report_log import *

sys.path.append('lib/smod/')
from System.Core.Global import *
from System.Core.Colors import *
from System.Core.Modbus import *

# Default values
outputAddr = '0x0000'
# FF00 - ON, 0000 - OFF
outputValue = 'FF00'

def printLine(str,color):
    if(str.find('[+]') != -1):
        print str.replace('[+]',color + '[+]' + bcolors.ENDC)
    elif(str.find('[-]') != -1):
        print str.replace('[-]',color + '[-]' + bcolors.ENDC)
    else:
        print str

def write_single_coils(ip, uid):
    if (ask_outputs() and is_valid_ipv4(ip) and is_valid_uid(uid)):
        c = connectToTarget(ip,502)
        report_log("Result of writing single coils")
        if(c == None):
            printLine('[-] Modbus is not running on : ' + ip,bcolors.WARNING)
            report_log('[-] Modbus is not running on : ' + ip)
            return None
        printLine('[+] Connecting to ' + ip,bcolors.OKGREEN)
        report_log('[+] Connecting to ' + ip)
        ans = c.sr1(ModbusADU(transId=getTransId(),unitId=int(uid))/ModbusPDU05_Write_Single_Coil(outputAddr=int(outputAddr,16),outputValue=int(outputValue,16)),timeout=timeout, verbose=1)
        ans = ModbusADU_Answer(str(ans))
        printLine('[+] Response is :',bcolors.OKGREEN)
        report_log('[+] Response is :')
        ans.show()
        modbus_report_log(ans)

def ask_outputs():
    global outputAddr
    global outputValue
    outputA = raw_input("Enter the output address (default address is 0): ")
    outputV = raw_input("Enter the output value (ON or OFF): ")
    if (is_valid_register(outputA) and is_valid_coil_value(outputV)):
        outputAddr = outputA
        outputValue = outputV
        return True
    else:
        return False


