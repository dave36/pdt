import os
import sys

sys.path.append('lib/smod/')
from System.Core.Global import *
from System.Core.Colors import *
from System.Core.Modbus import *


def printLine(str,color):
    if(str.find('[+]') != -1):
        print str.replace('[+]',color + '[+]' + bcolors.ENDC)
    elif(str.find('[-]') != -1):
        print str.replace('[-]',color + '[-]' + bcolors.ENDC)
    else:
        print str

def write_single_register(ip, uid):
    c = connectToTarget(ip,502)
    if(c == None):
        printLine('[-] Modbus is not running on : ' + ip,bcolors.WARNING)
        return
    printLine('[+] Writing single register to ' + ip,bcolors.OKGREEN)
    try:
        ans = c.sr1(ModbusADU(transId=getTransId(),unitId=int(uid))/ModbusPDU06_Write_Single_Register(registerAddr=int(hex(random.randint(0,16**4-1)|0x1111),16),registerValue=int(hex(random.randint(0,16**4-1)|0x1111),16)),timeout=timeout, verbose=0)
    except:
        pass
    return
